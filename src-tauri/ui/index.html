<html>

<head>
    <!-- UnityLoader-v3.js -->
    <script src="https://bulletforce.localhost/$$loader$$.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #gameContainer {
            margin: 0;
        }
    </style>
</head>

<body>
    <div id="gameContainer"></div>

    <script>
        // handle poki integration
        window.initPokiBridge = (n) => {
            console.log("initPokiBridge", n);
            window.gameInstance.SendMessage(n, "ready")
        };
        window.commercialBreak = function (n) {
            console.log("commercialBreak called!", arguments);
            window.gameInstance.SendMessage(n, "commercialBreakCompleted");
        };
        window.midrollSurprise = function () { console.log("midrollSurprise called!", arguments) };
        window.PokiSDK = {
            customEvent: function () { console.log("customEvent", arguments) },
            destroyAd: function () { console.log("destroyAd", arguments) },
            displayAd: function () { console.log("displayAd", arguments) },
            gameInteractive: function () { console.log("gameInteractive", arguments) },
        }

        function ptr_to_str(ptr) {
            return window.gameInstance.Module.ccall("$fake_ccall$", "string", ["number"], [ptr]);
        }

        function str_to_ptr(str) {
            return window.gameInstance.Module.ccall("$fake_ccall$", "number", ["string"], [str]);
        }

        function processWasmImports(imports) {
            let env = imports.env;
            env["_JS_Eval_EvalJS"] = (arg) => { console.log("EVAL JS", ptr_to_str(arg)) };

            // nop various calls
            let allowed_pokisdk_calls = ["_JS_PokiSDK_commercialBreak", "_JS_PokiSDK_initPokiBridge"];

            // disable all poki sdk calls except for whitelisted ones
            for (let key in env) {
                if (env.hasOwnProperty(key) && typeof env[key] == "function") {
                    if (!key.startsWith("_JS_PokiSDK_")) continue;
                    if (allowed_pokisdk_calls.indexOf(key) != -1) continue;

                    console.log("stubbing poki sdk call", key);
                    env[key] = function () { console.log(`stubbed poki call ${key} got called`, arguments); }
                }
            }

            // enable hooks
            let orig_socketCreate = env["_SocketCreate"];
            env["_SocketCreate"] = function (url, protocols) {
                let ret = orig_socketCreate(...arguments);
                console.log("_SocketCreate", ptr_to_str(url), ptr_to_str(protocols), ret);
                return ret;
            }
            let orig_webRequestCreate = env["_JS_WebRequest_Create"];
            env["_JS_WebRequest_Create"] = function (url, method) {
                url = str_to_ptr("http://localhost:48897/?" + ptr_to_str(url));
                let ret = orig_webRequestCreate(url, method);
                console.log("_JS_WebRequest_Create", ptr_to_str(url), ptr_to_str(method), ret);
                return ret;
            }

            // facilitate conversion functions, such as string to pointer
            // window.gameInstance.Module["_$fake_ccall$"] = (arg) => arg;
        }

        let orig_instantiate = WebAssembly.instantiate;
        WebAssembly.instantiate = function (source, importObject) {
            console.log("instantiating wasm object", importObject);
            processWasmImports(importObject);
            return orig_instantiate(source, importObject);
        }

        let orig_instantiateStreaming = WebAssembly.instantiateStreaming;
        WebAssembly.instantiateStreaming = function (source, importObject) {
            console.log("instantiateStreaming wasm object", importObject);
            processWasmImports(importObject);
            return orig_instantiateStreaming(source, importObject);
        }


        const url = "https://bulletforce.localhost/Build/$$game$$.json";
        window.gameInstance = UnityLoader.instantiate("gameContainer", url, {
            // onsuccess: function() {},
            // onerror: function() {},
            Module: {
                "_$fake_ccall$": (x) => x,
            },
        });
        console.log(window.gameInstance);
        // debugger;
    </script>
</body>

</html>