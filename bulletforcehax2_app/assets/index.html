<html>

<head>
    <script src="https://bulletforce.localhost/$$loader$$.js"></script>
</head>

<body style="margin:0">
    <div id="gameContainer"></div>

    <script>
        // handle poki integration
        window.initPokiBridge = (n) => {
            console.log("initPokiBridge called!", n);
            window.gameInstance.SendMessage(n, "ready");
        };
        window.commercialBreak = function (n) {
            console.log("commercialBreak called!", arguments);
            window.gameInstance.SendMessage(n, "commercialBreakCompleted");
        };
        window.midrollSurprise = function () { console.log("midrollSurprise called!", arguments) };

        function ptr_to_str(ptr) {
            return window.gameInstance.Module.ccall("$fake_ccall$", "string", ["number"], [ptr]);
        }

        // NOTE: you can only allocate a single string per hook
        function str_to_ptr(str) {
            return window.gameInstance.Module.ccall("$fake_ccall$", "number", ["string"], [str]);
        }

        function processWasmImports(imports) {
            let env = imports.env;

            env["_JS_Eval_EvalJS"] = (arg) => { console.log("EVAL JS", ptr_to_str(arg)) };

            // nop various poki api calls
            let allowed_pokisdk_calls = ["_JS_PokiSDK_commercialBreak", "_JS_PokiSDK_initPokiBridge"];
            for (let key in env) {
                if (env.hasOwnProperty(key) && typeof env[key] == "function") {
                    if (!key.startsWith("_JS_PokiSDK_")) continue;
                    if (allowed_pokisdk_calls.indexOf(key) != -1) continue;

                    console.log("stubbing poki sdk call", key);
                    env[key] = function () { console.log(`stubbed poki call ${key} got called`, arguments); }
                }
            }

            // enable hooks
            let orig_socketCreate = env["_SocketCreate"];
            env["_SocketCreate"] = function (url, protocols) {
                // NOTE: I can pass the protocol to the proxy as well, that may be useful in the future
                url = str_to_ptr("ws://localhost:48898/?" + ptr_to_str(url));
                let ret = orig_socketCreate(url, protocols);
                console.log("_SocketCreate", ptr_to_str(url), ptr_to_str(protocols), ret);
                return ret;
            }
            let orig_webRequestCreate = env["_JS_WebRequest_Create"];
            env["_JS_WebRequest_Create"] = function (url, method) {
                url = str_to_ptr("http://localhost:48897/?" + ptr_to_str(url));
                let ret = orig_webRequestCreate(url, method);
                console.log("_JS_WebRequest_Create", ptr_to_str(url), ptr_to_str(method), ret);
                return ret;
            }
        }

        let orig_instantiate = WebAssembly.instantiate;
        WebAssembly.instantiate = function (source, importObject) {
            console.log("instantiating wasm object", importObject);
            processWasmImports(importObject);
            return orig_instantiate(source, importObject);
        }

        let orig_instantiateStreaming = WebAssembly.instantiateStreaming;
        WebAssembly.instantiateStreaming = function (source, importObject) {
            console.log("instantiateStreaming wasm object", importObject);
            processWasmImports(importObject);
            return orig_instantiateStreaming(source, importObject);
        }


        const url = "https://bulletforce.localhost/Build/$$game$$.json";
        window.gameInstance = UnityLoader.instantiate("gameContainer", url, {
            Module: { "_$fake_ccall$": x => x, },
        });
        console.log("Game instance", window.gameInstance);
    </script>
</body>

</html>